<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°°ë“œë§¥ìŠ¤ ì›”ë¡€ëŒ€íšŒ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    .locked-badge{background:rgba(15,23,42,.08);border:1px solid rgba(15,23,42,.12)}
    .drag-ghost{opacity:.4}
    @media print{
      .no-print{display:none!important}
      body{background:white!important}
      .print-card{box-shadow:none!important;border:1px solid #e5e7eb!important}
      input,textarea{border:0!important;background:transparent!important}
      details{open:true}
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-3 sm:p-4 md:p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight leading-tight">
          ë°°ë“œë§¥ìŠ¤ <span id="ymBadge" class="px-2 py-1 rounded-xl font-extrabold"></span> ì›”ë¡€ëŒ€íšŒ
        </h1>
        <div class="mt-2 flex flex-wrap items-center gap-2">
          <span id="modeBadge" class="locked-badge text-slate-800 text-xs font-bold px-2 py-1 rounded-xl">ğŸ”’ ë·°ì–´ ëª¨ë“œ(ì½ê¸° ì „ìš©)</span>
          <span class="text-xs text-slate-500">ëª…ë‹¨/ê²½ê¸°/ì ìˆ˜ëŠ” ì´ ê¸°ê¸° ë¸Œë¼ìš°ì €(localStorage)ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
      </div>

      <div class="no-print flex gap-2 flex-wrap">
        <button id="btnUnlock" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold hover:bg-slate-800">ê´€ë¦¬ì ëª¨ë“œ</button>
        <button id="btnPrint" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì¸ì‡„/ì¶œë ¥</button>
        <button id="btnReset" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- Top grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-4">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">ì—‘ì…€ ì—…ë¡œë“œ</h2>
        <div class="no-print" data-admin-only>
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="w-full block p-2 border rounded-xl" />
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnClearPeople" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ëª…ë‹¨ ë¹„ìš°ê¸°</button>
            <button id="btnNormalize" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì •ë¦¬(ì¤‘ë³µ ì œê±°)</button>
          </div>
        </div>
        <div class="mt-3 text-sm text-slate-600">
          ì—‘ì…€ ì—…ë¡œë“œëŠ” â€œëª…ë‹¨ ë°ì´í„°â€ë¡œë§Œ ë°˜ì˜ë©ë‹ˆë‹¤. íŒŒì¼ ìì²´ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
      </div>

      <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">í˜„ì¬ ì¸ì›</h2>
        <div class="flex items-center justify-between">
          <div class="text-slate-600">ì „ì²´</div>
          <div id="countAll" class="text-3xl font-extrabold">0</div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-3">
          <div class="rounded-2xl border border-slate-200 p-3">
            <div class="text-slate-600 text-sm">ë‚¨</div>
            <div id="countM" class="text-2xl font-bold mt-1">0</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-3">
            <div class="text-slate-600 text-sm">ì—¬</div>
            <div id="countF" class="text-2xl font-bold mt-1">0</div>
          </div>
        </div>

        <div id="warnBox" class="mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-2 hidden"></div>

        <div class="mt-3 no-print grid grid-cols-1 gap-2" data-admin-only>
          <button id="btnAssign" class="w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-500">íŒ€ ë°°ì •(A/B)</button>
          <button id="btnMakeMatches" class="w-full px-4 py-3 rounded-2xl bg-indigo-600 text-white font-extrabold hover:bg-indigo-500">
            ê²½ê¸° ìƒì„±(ë‚¨ë³µ/ì—¬ë³µ + í˜¼ë³µ 1ê²½ê¸°)
          </button>
        </div>
      </div>
    </div>

    <!-- Manual add/remove -->
    <div class="no-print grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-4" data-admin-only>
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">ìˆ˜ë™ ì¶”ê°€</h2>
        <textarea id="manualInput" class="w-full min-h-[110px] p-3 border rounded-2xl focus:outline-none focus:ring-2 focus:ring-slate-300"
          placeholder="ì˜ˆ) í™ê¸¸ë™ 1998 ë‚¨&#10;ê¹€ë¯¸ì†¡ 1991 ì—¬"></textarea>

        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnAddManual" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold hover:bg-slate-800">ì¶”ê°€</button>
          <button id="btnClearManual" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì…ë ¥ì¹¸ ë¹„ìš°ê¸°</button>
        </div>

        <div class="mt-3">
          <div class="text-sm font-bold text-slate-700 mb-1">ì¶”ê°€ëœ ì¸ì›</div>
          <pre id="addedManual" class="bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 whitespace-pre-wrap">(ì—†ìŒ)</pre>
        </div>

        <div class="mt-3">
          <div class="text-sm font-bold text-slate-700 mb-1">ì¶”ê°€ ì‹¤íŒ¨ ë¼ì¸</div>
          <pre id="failedManual" class="bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 whitespace-pre-wrap">(ì—†ìŒ)</pre>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">ìˆ˜ë™ ì œê±°(ìš´ì˜ì§„ ì œì™¸ ë“±)</h2>
        <textarea id="removeInput" class="w-full min-h-[110px] p-3 border rounded-2xl focus:outline-none focus:ring-2 focus:ring-slate-300"
          placeholder="ì´ë¦„ë§Œ í•œ ì¤„ì”© ì…ë ¥&#10;ì˜ˆ) í™ê¸¸ë™&#10;í™ê¸¸ìˆœ"></textarea>

        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnRemoveByName" class="px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold hover:bg-rose-500">ëª…ë‹¨ì—ì„œ ì œì™¸</button>
          <button id="btnClearRemove" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì…ë ¥ì¹¸ ë¹„ìš°ê¸°</button>
        </div>

        <div class="mt-3">
          <div class="text-sm font-bold text-slate-700 mb-1">ì œì™¸ ê²°ê³¼</div>
          <pre id="removeResult" class="bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 whitespace-pre-wrap">(ì—†ìŒ)</pre>
        </div>
      </div>
    </div>

    <!-- Scoreboard -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 mb-4">
      <h2 class="font-extrabold text-xl md:text-2xl">ìµœì¢… ìŠ¤ì½”ì–´(ìŠ¹ìˆ˜)</h2>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
        <div class="rounded-3xl border border-slate-200 p-5 bg-slate-50 text-center">
          <div class="text-slate-600 text-sm">AíŒ€ ìŠ¹</div>
          <div id="winsA" class="text-5xl font-extrabold mt-2">0</div>
        </div>
        <div class="rounded-3xl border border-slate-200 p-5 bg-slate-900 text-white text-center">
          <div class="text-sm opacity-80">ìµœì¢… ìš°ìŠ¹</div>
          <div id="champion" class="text-4xl md:text-5xl font-extrabold mt-2">â€”</div>
        </div>
        <div class="rounded-3xl border border-slate-200 p-5 bg-slate-50 text-center">
          <div class="text-slate-600 text-sm">BíŒ€ ìŠ¹</div>
          <div id="winsB" class="text-5xl font-extrabold mt-2">0</div>
        </div>
      </div>
    </div>

    <!-- Teams -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-4">
      <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between">
          <h2 class="font-extrabold text-lg">AíŒ€ ëª…ë‹¨</h2>
          <span id="countA" class="text-sm text-slate-600">0ëª…</span>
        </div>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ë‚¨ì</div>
            <ul id="teamA_m" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ì—¬ì</div>
            <ul id="teamA_f" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
        </div>
      </div>

      <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between">
          <h2 class="font-extrabold text-lg">BíŒ€ ëª…ë‹¨</h2>
          <span id="countB" class="text-sm text-slate-600">0ëª…</span>
        </div>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ë‚¨ì</div>
            <ul id="teamB_m" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ì—¬ì</div>
            <ul id="teamB_f" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Matches -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
      <h2 class="font-extrabold text-lg">ê²½ê¸°í‘œ</h2>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold text-slate-800 mb-2">ë‚¨ì ë³µì‹(4ì¸: A2 vs B2)</h3>
          <div id="matchesM" class="flex flex-col gap-3"></div>
          <div id="leftM" class="mt-2 text-sm text-slate-600"></div>
        </div>
        <div>
          <h3 class="font-bold text-slate-800 mb-2">ì—¬ì ë³µì‹(4ì¸: A2 vs B2)</h3>
          <div id="matchesF" class="flex flex-col gap-3"></div>
          <div id="leftF" class="mt-2 text-sm text-slate-600"></div>
        </div>
      </div>

      <!-- Mixed at bottom -->
      <div class="mt-6">
        <h3 class="font-extrabold text-slate-900 mb-2">í˜¼í•© ë³µì‹(ë§¨ ì•„ë˜ 1ê²½ê¸°)</h3>
        <div id="mixedBox" class="rounded-2xl border border-slate-200 bg-gradient-to-br from-amber-50 to-white p-3">
          <div class="flex items-start justify-between gap-2">
            <div class="font-extrabold">í˜¼ë³µ M-1</div>
            <div id="winbox-MIX-1" class="px-4 py-2 rounded-2xl font-extrabold text-lg bg-slate-200 text-slate-800">
              ìŠ¹ë¦¬: <span id="winner-MIX-1">â€”</span>
            </div>
          </div>

          <div id="mixedPlayers" class="mt-2"></div>

          <div class="mt-3 grid grid-cols-2 gap-2 items-center" data-admin-only>
            <div>
              <label class="text-xs text-slate-600">A ì ìˆ˜</label>
              <input id="mixScoreA" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric" placeholder="ì˜ˆ: 21" />
            </div>
            <div>
              <label class="text-xs text-slate-600">B ì ìˆ˜</label>
              <input id="mixScoreB" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric" placeholder="ì˜ˆ: 18" />
            </div>
          </div>

          <div id="mixedNote" class="mt-2 text-xs text-slate-600"></div>
        </div>
      </div>
    </div>

    <!-- Event game (collapsible) -->
    <details id="eventDetails" class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
      <summary class="cursor-pointer font-extrabold text-lg select-none">ì´ë²¤íŠ¸ ê²½ê¸°: ì•‰ì€ë±…ì´ ë¯¼í„´(ì ‘ê¸°/í¼ì¹˜ê¸°)</summary>

      <div class="mt-3 flex items-center justify-between flex-wrap gap-2">
        <div class="text-sm text-slate-600">AíŒ€/BíŒ€ì—ì„œ ëœë¤ìœ¼ë¡œ 9ëª…ì”©(ê°€ëŠ¥í•œ ë§Œí¼) ë½‘ì•„ì„œ 15ì  ê²½ê¸°</div>
        <div class="no-print flex gap-2" data-admin-only>
          <button id="btnEventPick" class="px-3 py-2 rounded-xl bg-slate-900 text-white font-semibold hover:bg-slate-800">ëœë¤ ì¸ì› ìƒì„±</button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold mb-2">AíŒ€ (ìµœëŒ€ 9ëª…)</div>
          <ol id="eventA" class="list-decimal list-inside text-sm text-slate-800 space-y-1"></ol>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold mb-2">BíŒ€ (ìµœëŒ€ 9ëª…)</div>
          <ol id="eventB" class="list-decimal list-inside text-sm text-slate-800 space-y-1"></ol>
        </div>
      </div>

      <div class="mt-3 rounded-2xl border border-slate-200 p-3 bg-white">
        <div class="flex items-start justify-between gap-2 flex-wrap">
          <div class="font-extrabold">ì´ë²¤íŠ¸ ì ìˆ˜(15ì )</div>
          <div id="eventWinnerPill" class="px-4 py-2 rounded-2xl font-extrabold text-lg bg-slate-200 text-slate-800">ìŠ¹ë¦¬: â€”</div>
        </div>

        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2" data-admin-only>
          <div>
            <label class="text-xs text-slate-600">A ì ìˆ˜</label>
            <input id="eventScoreA" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric" placeholder="ì˜ˆ: 15" />
          </div>
          <div>
            <label class="text-xs text-slate-600">B ì ìˆ˜</label>
            <input id="eventScoreB" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric" placeholder="ì˜ˆ: 12" />
          </div>
        </div>
      </div>
    </details>

    <!-- Gift order -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-6">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <h2 class="font-extrabold text-lg">ì„ ë¬¼ ìˆœì„œ</h2>
        <div class="no-print" data-admin-only>
          <button id="btnGiftOrder" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-extrabold hover:bg-indigo-500">ìˆœì„œ ìƒì„±í•˜ê¸°</button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold mb-2">ìš°ìŠ¹íŒ€ ìˆœì„œ</div>
          <ol id="giftWin" class="list-decimal list-inside text-sm text-slate-800 space-y-1"></ol>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold mb-2">íŒ¨ë°°íŒ€ ìˆœì„œ</div>
          <ol id="giftLose" class="list-decimal list-inside text-sm text-slate-800 space-y-1"></ol>
        </div>
      </div>

      <div id="giftNote" class="mt-2 text-xs text-slate-600"></div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const ADMIN_PASSWORD = "13579";
const STORAGE_KEY_STATE = "badmax_state_full_v1";
const STORAGE_KEY_LOCK  = "badmax_admin_unlocked_v1";

function setYearMonthTitle(){
  const d=new Date(); const y=d.getFullYear(); const m=d.getMonth()+1;
  $("ymBadge").textContent=`${y}ë…„ ${m}ì›”`;
  $("ymBadge").className="px-2 py-1 rounded-xl font-extrabold bg-indigo-600 text-white";
  document.title=`ë°°ë“œë§¥ìŠ¤ ${y}ë…„ ${m}ì›” ì›”ë¡€ëŒ€íšŒ`;
}
setYearMonthTitle();

const state = {
  people: [],
  teamA: [],
  teamB: [],
  matchesM: [],
  matchesF: [],
  mixed: { slots: null, scoreA:"", scoreB:"" }, // slots: {Am,Af,Bm,Bf}
  event: { A:[], B:[], scoreA:"", scoreB:"" },
  gift: { win:[], lose:[] }
};

function isUnlocked(){ return localStorage.getItem(STORAGE_KEY_LOCK)==="1"; }
function setUnlocked(v){ localStorage.setItem(STORAGE_KEY_LOCK, v?"1":"0"); applyLockUI(); }

$("btnUnlock").addEventListener("click", ()=>{
  if(isUnlocked()){ setUnlocked(false); return; }
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(pw===null) return;
  if(pw===ADMIN_PASSWORD) setUnlocked(true);
  else alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
});

let saveTimer=null;
function saveStateDebounced(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(state)), 200);
}
function loadStateFromStorage(){
  const raw=localStorage.getItem(STORAGE_KEY_STATE);
  if(!raw) return;
  try{
    const data=JSON.parse(raw);
    Object.assign(state, data);
    state.people = state.people || [];
    state.teamA = state.teamA || [];
    state.teamB = state.teamB || [];
    state.matchesM = state.matchesM || [];
    state.matchesF = state.matchesF || [];
    state.mixed = state.mixed || {slots:null,scoreA:"",scoreB:""};
    state.event = state.event || {A:[],B:[],scoreA:"",scoreB:""};
    state.gift = state.gift || {win:[],lose:[]};
  }catch(e){}
}

function applyLockUI(){
  const unlocked=isUnlocked();
  const badge=$("modeBadge");
  const btn=$("btnUnlock");

  if(unlocked){
    badge.textContent="âœ… ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)";
    badge.className="text-xs font-bold px-2 py-1 rounded-xl bg-emerald-600 text-white";
    btn.textContent="ê´€ë¦¬ì ì ê¸ˆ";
  }else{
    badge.textContent="ğŸ”’ ë·°ì–´ ëª¨ë“œ(ì½ê¸° ì „ìš©)";
    badge.className="locked-badge text-slate-800 text-xs font-bold px-2 py-1 rounded-xl";
    btn.textContent="ê´€ë¦¬ì ëª¨ë“œ";
  }

  document.querySelectorAll("[data-admin-only]").forEach(el=>{
    el.style.display = unlocked ? "" : "none";
  });

  setupTeamSortables();
  bindScoreInputsDisabled();
}

function normGender(g){
  const s=(g??"").toString().trim().toUpperCase();
  if(["ë‚¨","ë‚¨ì","M","MALE"].includes(s)) return "ë‚¨";
  if(["ì—¬","ì—¬ì","F","FEMALE"].includes(s)) return "ì—¬";
  return "ë¯¸ì •";
}
function keyOf(p){ return `${p.name}|${p.year}|${p.gender}`; }
function dedupePeople(list){
  const seen=new Set(); const res=[];
  for(const p of list){
    const k=keyOf(p);
    if(!seen.has(k)){ seen.add(k); res.push(p); }
  }
  return res;
}
function sortByElderFirst(list){
  return [...list].sort((a,b)=>(a.year-b.year)||a.name.localeCompare(b.name));
}
function countByGender(list){
  let m=0,f=0,u=0;
  for(const p of list){
    if(p.gender==="ë‚¨") m++;
    else if(p.gender==="ì—¬") f++;
    else u++;
  }
  return {m,f,u};
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function winnerCode(scoreA,scoreB){
  const a=parseInt(scoreA,10), b=parseInt(scoreB,10);
  if(!Number.isFinite(a)||!Number.isFinite(b)) return "";
  if(a>b) return "A";
  if(b>a) return "B";
  return "D";
}
function winnerText(code){
  if(code==="A") return "AíŒ€";
  if(code==="B") return "BíŒ€";
  if(code==="D") return "ë¬´ìŠ¹ë¶€";
  return "â€”";
}
function winnerPillClass(code){
  if(code==="A") return "bg-emerald-600 text-white";
  if(code==="B") return "bg-blue-600 text-white";
  if(code==="D") return "bg-slate-600 text-white";
  return "bg-slate-200 text-slate-800";
}
function label(p){ return `${p.name} (${p.year})`; }

// Excel
function guessColumn(headers,cands){
  const lower=headers.map(h=>(h??"").toString().trim().toLowerCase());
  for(const cand of cands){
    const idx=lower.findIndex(h=>h.includes(cand));
    if(idx!==-1) return idx;
  }
  return -1;
}
async function loadExcelFile(file){
  const buf=await file.arrayBuffer();
  const wb=XLSX.read(new Uint8Array(buf), {type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
  if(!rows.length) return [];
  const headers=rows[0].map(x=>x.toString());
  const idxName=guessColumn(headers,["ì´ë¦„","ì„±ëª…","name"]);
  const idxYear=guessColumn(headers,["ì¶œìƒì—°ë„","ì¶œìƒ","year","birth","ë…„ë„"]);
  const idxGender=guessColumn(headers,["ì„±ë³„","ë‚¨ì—¬","gender","sex"]);
  const nI=idxName!==-1?idxName:0;
  const yI=idxYear!==-1?idxYear:1;
  const gI=idxGender!==-1?idxGender:2;

  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r];
    const name=(row[nI]??"").toString().trim();
    if(!name) continue;
    const year=parseInt((row[yI]??"").toString().trim(),10);
    const gender=normGender((row[gI]??"").toString().trim());
    out.push({name,year,gender});
  }
  return out;
}

// Manual add/remove
function parseManualLines(text){
  const lines=(text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const out=[]; const failed=[];
  const re=/^(.+?)\s+(\d{4})\s+(ë‚¨|ì—¬|ë‚¨ì|ì—¬ì|M|F)\s*$/i;
  for(const line of lines){
    const m=line.match(re);
    if(!m){ failed.push(line); continue; }
    const name=m[1].trim();
    const year=parseInt(m[2],10);
    const gender=normGender(m[3]);
    if(!(year>=1900&&year<=2099)){ failed.push(line+"  (ì—°ë„ ë²”ìœ„ ì˜¤ë¥˜)"); continue; }
    if(gender==="ë¯¸ì •"){ failed.push(line+"  (ì„±ë³„ ì¸ì‹ ì‹¤íŒ¨)"); continue; }
    out.push({name,year,gender});
  }
  return {out,failed};
}
function removeByNames(names){
  const set=new Set(names.map(n=>n.trim()).filter(Boolean));
  if(!set.size) return {removed:0, notFound:[]};
  const before=state.people.length;
  const existed=new Set(state.people.map(p=>p.name));
  state.people=state.people.filter(p=>!set.has(p.name));
  state.teamA=state.teamA.filter(p=>!set.has(p.name));
  state.teamB=state.teamB.filter(p=>!set.has(p.name));
  const removed=before-state.people.length;
  const notFound=[...set].filter(n=>!existed.has(n));
  return {removed, notFound};
}

// Team assign: ë‚¨ì êµì°¨ -> ì—¬ì êµì°¨
function assignTeamsCross(){
  const all=dedupePeople(state.people).filter(p=>p.gender==="ë‚¨"||p.gender==="ì—¬");
  const males=sortByElderFirst(all.filter(p=>p.gender==="ë‚¨"));
  const females=sortByElderFirst(all.filter(p=>p.gender==="ì—¬"));
  const A=[],B=[];
  let t=true;
  for(const p of males){ (t?A:B).push(p); t=!t; }
  for(const p of females){ (t?A:B).push(p); t=!t; }
  state.teamA=A; state.teamB=B;
}

// Make doubles: 4ì¸(A2 vs B2)
function makeStrictDoubles4(gender, prefix){
  const A=sortByElderFirst(state.teamA.filter(p=>p.gender===gender));
  const B=sortByElderFirst(state.teamB.filter(p=>p.gender===gender));
  const matches=[];
  let i=1;
  while(A.length>=2 && B.length>=2){
    const slots=[A.shift(),A.shift(),B.shift(),B.shift()];
    matches.push({ id:`${prefix}-${i++}`, slots, scoreA:"", scoreB:"" });
  }
  // leftovers for display
  return {matches, leftA:A, leftB:B};
}

function usedSetFromMatches(){
  const used=new Set();
  for(const m of [...state.matchesM,...state.matchesF]){
    for(const p of m.slots) used.add(keyOf(p));
  }
  return used;
}

// Mixed: create ONE match based on leftovers + closest age
function pickClosestByYear(pool, targetYear){
  if(!pool.length) return null;
  let best=pool[0], bestDiff=Math.abs(pool[0].year-targetYear);
  for(const p of pool){
    const d=Math.abs(p.year-targetYear);
    if(d<bestDiff){ best=p; bestDiff=d; }
  }
  return best;
}
function removeFromPool(pool, picked){
  const k=keyOf(picked);
  const idx=pool.findIndex(p=>keyOf(p)===k);
  if(idx!==-1) pool.splice(idx,1);
}
function buildMixedOneMatch(leftAm,leftAf,leftBm,leftBf, used){
  // candidates from leftovers first
  const A_m_left=shuffle(leftAm);
  const A_f_left=shuffle(leftAf);
  const B_m_left=shuffle(leftBm);
  const B_f_left=shuffle(leftBf);

  // helper: pick same team other gender if missing
  function pickFromTeam(teamArr, gender, preferPlayed=true){
    const all=teamArr.filter(p=>p.gender===gender);
    if(!all.length) return null;
    const played = shuffle(all.filter(p=>used.has(keyOf(p))));
    const notPlayed = shuffle(all.filter(p=>!used.has(keyOf(p))));
    if(preferPlayed) return played[0] || notPlayed[0] || null;
    return notPlayed[0] || played[0] || null;
  }

  // Step 1) ensure A has (m,f) using leftovers first
  let Am = A_m_left.shift() || null;
  let Af = A_f_left.shift() || null;

  // If A has one leftover only, attach other gender from same team (prefer already played)
  if(Am && !Af) Af = pickFromTeam(state.teamA,"ì—¬",true);
  if(Af && !Am) Am = pickFromTeam(state.teamA,"ë‚¨",true);

  // If still missing -> cannot form A side
  if(!(Am && Af)) return {slots:null, note:"AíŒ€ì—ì„œ í˜¼ë³µ(ë‚¨+ì—¬) êµ¬ì„±ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."};

  // Step 2) Build B side similar, but choose closest age to Aâ€™s players
  // Prefer leftovers first, but closest age within leftovers; if none -> from teamB (prefer played)
  let Bm = null;
  let Bf = null;

  // For B male: choose closest to Am.year from leftover males if exists
  if(B_m_left.length){
    Bm = pickClosestByYear(B_m_left, Am.year);
    removeFromPool(B_m_left, Bm);
  } else {
    Bm = pickFromTeam(state.teamB,"ë‚¨",true);
  }

  // For B female: closest to Af.year
  if(B_f_left.length){
    Bf = pickClosestByYear(B_f_left, Af.year);
    removeFromPool(B_f_left, Bf);
  } else {
    Bf = pickFromTeam(state.teamB,"ì—¬",true);
  }

  if(!(Bm && Bf)) return {slots:null, note:"BíŒ€ì—ì„œ í˜¼ë³µ(ë‚¨+ì—¬) êµ¬ì„±ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."};

  return {slots:{Am,Af,Bm,Bf}, note:"ë‚¨ëŠ” ì¸ì›ì„ ìš°ì„  ì‚¬ìš©í•˜ê³ , ë¶€ì¡±í•˜ë©´ ê°™ì€ íŒ€ ì¸ì›ìœ¼ë¡œ ì±„ì› ìŠµë‹ˆë‹¤(ìƒëŒ€ëŠ” ë¹„ìŠ·í•œ ì—°ë ¹ëŒ€ë¡œ ë§¤ì¹­)."};
}

// Render counts/teams
function renderCounts(){
  state.people=dedupePeople(state.people);
  const {m,f,u}=countByGender(state.people);
  $("countAll").textContent=state.people.length;
  $("countM").textContent=m;
  $("countF").textContent=f;

  const warn=[];
  if(u>0) warn.push(`ì„±ë³„ ë¯¸ì • ${u}ëª…(ì •ë¦¬ í•„ìš”)`);
  if(state.people.length===0) warn.push("ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
  $("warnBox").textContent=warn.join(" / ");
  $("warnBox").classList.toggle("hidden", warn.length===0);
}

function emptyLi(){
  return `<li class="text-sm text-slate-500 px-3 py-2 rounded-xl border border-dashed border-slate-200 bg-white">(ë¹„ì–´ìˆìŒ)</li>`;
}
function teamLi(p, idx){
  const badge=p.gender==="ë‚¨"
    ? "bg-sky-50 text-sky-700 border-sky-200"
    : "bg-pink-50 text-pink-700 border-pink-200";
  return `
    <li class="team-item flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white cursor-grab active:cursor-grabbing"
        data-name="${p.name}" data-year="${p.year}" data-gender="${p.gender}">
      <div class="min-w-0">
        <div class="font-semibold truncate">
          <span class="text-slate-500 mr-2">${idx}.</span>${p.name}
          <span class="text-slate-400">(${p.year})</span>
        </div>
      </div>
      <span class="text-xs px-2 py-1 rounded-full border ${badge}">${p.gender}</span>
    </li>
  `;
}
function renderTeamLists(){
  $("countA").textContent=`${state.teamA.length}ëª…`;
  $("countB").textContent=`${state.teamB.length}ëª…`;

  const Am=sortByElderFirst(state.teamA.filter(p=>p.gender==="ë‚¨"));
  const Af=sortByElderFirst(state.teamA.filter(p=>p.gender==="ì—¬"));
  const Bm=sortByElderFirst(state.teamB.filter(p=>p.gender==="ë‚¨"));
  const Bf=sortByElderFirst(state.teamB.filter(p=>p.gender==="ì—¬"));

  $("teamA_m").innerHTML = Am.length ? Am.map((p,i)=>teamLi(p,i+1)).join("") : emptyLi();
  $("teamA_f").innerHTML = Af.length ? Af.map((p,i)=>teamLi(p,i+1)).join("") : emptyLi();
  $("teamB_m").innerHTML = Bm.length ? Bm.map((p,i)=>teamLi(p,i+1)).join("") : emptyLi();
  $("teamB_f").innerHTML = Bf.length ? Bf.map((p,i)=>teamLi(p,i+1)).join("") : emptyLi();

  setupTeamSortables();
}

function setupTeamSortables(){
  const unlocked=isUnlocked();
  const lists=["teamA_m","teamA_f","teamB_m","teamB_f"].map(id=>document.getElementById(id));
  for(const ul of lists){
    if(ul._sortableTeams) ul._sortableTeams.destroy();
    if(!unlocked) continue;

    ul._sortableTeams = new Sortable(ul,{
      group:"teamsMove",
      animation:150,
      ghostClass:"drag-ghost",
      onEnd: ()=>{
        syncTeamsFromDOM();
        // íŒ€ ë°”ê¾¸ë©´ ê²½ê¸°/í˜¼ë³µ/ì´ë²¤íŠ¸/ì„ ë¬¼ì€ ë‹¤ì‹œ ìƒì„± ê¶Œì¥ -> ì•ˆì „í•˜ê²Œ ë¹„ì›€
        state.matchesM=[]; state.matchesF=[];
        state.mixed={slots:null,scoreA:"",scoreB:""};
        state.event={A:[],B:[],scoreA:"",scoreB:""};
        state.gift={win:[],lose:[]};
        renderAll();
        saveStateDebounced();
      }
    });
  }
}
function syncTeamsFromDOM(){
  const readList=(id)=>{
    const ul=document.getElementById(id);
    const items=Array.from(ul.querySelectorAll("li.team-item"));
    const res=[];
    for(const li of items){
      const name=li.dataset.name;
      const year=parseInt(li.dataset.year,10);
      const gender=li.dataset.gender;
      if(name && Number.isFinite(year) && (gender==="ë‚¨"||gender==="ì—¬")) res.push({name,year,gender});
    }
    return res;
  };
  const A=[...readList("teamA_m"),...readList("teamA_f")];
  const B=[...readList("teamB_m"),...readList("teamB_f")];
  state.teamA = sortByElderFirst(A.filter(p=>p.gender==="ë‚¨")).concat(sortByElderFirst(A.filter(p=>p.gender==="ì—¬")));
  state.teamB = sortByElderFirst(B.filter(p=>p.gender==="ë‚¨")).concat(sortByElderFirst(B.filter(p=>p.gender==="ì—¬")));
}

// Match cards
const THEMES=[
  "bg-gradient-to-br from-sky-50 to-white border-sky-100",
  "bg-gradient-to-br from-emerald-50 to-white border-emerald-100",
  "bg-gradient-to-br from-indigo-50 to-white border-indigo-100",
  "bg-gradient-to-br from-rose-50 to-white border-rose-100",
  "bg-gradient-to-br from-amber-50 to-white border-amber-100",
  "bg-gradient-to-br from-violet-50 to-white border-violet-100",
  "bg-gradient-to-br from-cyan-50 to-white border-cyan-100",
  "bg-gradient-to-br from-lime-50 to-white border-lime-100",
];
function matchCard(m, idx){
  const theme=THEMES[idx % THEMES.length];
  const code=winnerCode(m.scoreA,m.scoreB);
  return `
    <div class="rounded-2xl border ${theme} p-3">
      <div class="flex items-start justify-between gap-2">
        <div class="font-extrabold">ê²½ê¸° ${m.id}</div>
        <div id="winbox-${m.id}" class="px-4 py-2 rounded-2xl font-extrabold text-lg ${winnerPillClass(code)}">
          ìŠ¹ë¦¬: <span id="winner-${m.id}">${winnerText(code)}</span>
        </div>
      </div>

      <ul class="mt-2 flex flex-col gap-2">
        ${[0,1,2,3].map(i=>`
          <li class="flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white">
            <div class="font-semibold truncate">${label(m.slots[i])}</div>
            <span class="text-xs text-slate-500">${i<2 ? "AíŒ€" : "BíŒ€"}</span>
          </li>
        `).join("")}
      </ul>

      <div class="mt-3 grid grid-cols-2 gap-2 items-center" data-admin-only>
        <div>
          <label class="text-xs text-slate-600">A ì ìˆ˜</label>
          <input class="scoreA w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric"
            placeholder="ì˜ˆ: 21" value="${m.scoreA ?? ""}" data-matchid="${m.id}" />
        </div>
        <div>
          <label class="text-xs text-slate-600">B ì ìˆ˜</label>
          <input class="scoreB w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric"
            placeholder="ì˜ˆ: 18" value="${m.scoreB ?? ""}" data-matchid="${m.id}" />
        </div>
      </div>
    </div>
  `;
}
function findMatchById(id){
  return [...state.matchesM,...state.matchesF].find(x=>x.id===id);
}
function updateWinnerUI(m){
  const code=winnerCode(m.scoreA,m.scoreB);
  const box=document.getElementById(`winbox-${m.id}`);
  const span=document.getElementById(`winner-${m.id}`);
  if(span) span.textContent=winnerText(code);
  if(box) box.className=`px-4 py-2 rounded-2xl font-extrabold text-lg ${winnerPillClass(code)}`;
}
function renderMatches(){
  $("matchesM").innerHTML=state.matchesM.map((m,i)=>matchCard(m,i)).join("");
  $("matchesF").innerHTML=state.matchesF.map((m,i)=>matchCard(m,i+state.matchesM.length)).join("");
  bindDoublesScoreInputs();
}

function bindDoublesScoreInputs(){
  const unlocked=isUnlocked();
  document.querySelectorAll("input.scoreA").forEach(inp=>{
    inp.disabled=!unlocked;
    inp.classList.toggle("opacity-60", !unlocked);
    inp.addEventListener("input",(e)=>{
      const m=findMatchById(e.target.dataset.matchid);
      if(!m) return;
      m.scoreA=e.target.value;
      updateWinnerUI(m);
      recomputeScoreboard();
      saveStateDebounced();
    });
  });
  document.querySelectorAll("input.scoreB").forEach(inp=>{
    inp.disabled=!unlocked;
    inp.classList.toggle("opacity-60", !unlocked);
    inp.addEventListener("input",(e)=>{
      const m=findMatchById(e.target.dataset.matchid);
      if(!m) return;
      m.scoreB=e.target.value;
      updateWinnerUI(m);
      recomputeScoreboard();
      saveStateDebounced();
    });
  });
}

// Mixed render + score
function renderMixed(){
  const s=state.mixed.slots;
  if(!s){
    $("mixedPlayers").innerHTML = `<div class="text-sm text-slate-600">í˜¼í•©ë³µì‹ì„ ë§Œë“¤ ìˆ˜ ì—†ê±°ë‚˜ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
    $("mixedNote").textContent = "ë‚¨ëŠ” ì¸ì›ì´ ì—†ê±°ë‚˜(ëª¨ë‘ ë³µì‹ìœ¼ë¡œ ì†Œì§„), íŒ€ ì„±ë¹„ê°€ ë¶€ì¡±í•´ í˜¼ë³µ(ë‚¨+ì—¬ vs ë‚¨+ì—¬)ì„ êµ¬ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    $("mixScoreA").value = "";
    $("mixScoreB").value = "";
    setMixedWinnerPill("", "");
    return;
  }

  $("mixedPlayers").innerHTML = `
    <ul class="mt-2 flex flex-col gap-2">
      <li class="flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white">
        <div class="font-semibold truncate">${label(s.Am)}</div><span class="text-xs text-slate-500">AíŒ€ ë‚¨</span>
      </li>
      <li class="flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white">
        <div class="font-semibold truncate">${label(s.Af)}</div><span class="text-xs text-slate-500">AíŒ€ ì—¬</span>
      </li>
      <li class="flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white">
        <div class="font-semibold truncate">${label(s.Bm)}</div><span class="text-xs text-slate-500">BíŒ€ ë‚¨</span>
      </li>
      <li class="flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white">
        <div class="font-semibold truncate">${label(s.Bf)}</div><span class="text-xs text-slate-500">BíŒ€ ì—¬</span>
      </li>
    </ul>
  `;

  $("mixedNote").textContent = state.mixed.note || "";
  $("mixScoreA").value = state.mixed.scoreA ?? "";
  $("mixScoreB").value = state.mixed.scoreB ?? "";
  setMixedWinnerPill(state.mixed.scoreA, state.mixed.scoreB);
}
function setMixedWinnerPill(a,b){
  const code=winnerCode(a,b);
  $("winner-MIX-1").textContent = winnerText(code);
  const box=$("winbox-MIX-1");
  box.className = `px-4 py-2 rounded-2xl font-extrabold text-lg ${winnerPillClass(code)}`;
}
function bindMixedScore(){
  const unlocked=isUnlocked();
  $("mixScoreA").disabled=!unlocked;
  $("mixScoreB").disabled=!unlocked;
  $("mixScoreA").classList.toggle("opacity-60", !unlocked);
  $("mixScoreB").classList.toggle("opacity-60", !unlocked);

  $("mixScoreA").oninput = (e)=>{
    if(!isUnlocked()) return;
    state.mixed.scoreA = e.target.value;
    setMixedWinnerPill(state.mixed.scoreA, state.mixed.scoreB);
    recomputeScoreboard();
    saveStateDebounced();
  };
  $("mixScoreB").oninput = (e)=>{
    if(!isUnlocked()) return;
    state.mixed.scoreB = e.target.value;
    setMixedWinnerPill(state.mixed.scoreA, state.mixed.scoreB);
    recomputeScoreboard();
    saveStateDebounced();
  };
}

// Leftover display
function renderLeftovers(leftMale, leftFemale){
  $("leftM").textContent = leftMale ? leftMale : "";
  $("leftF").textContent = leftFemale ? leftFemale : "";
}

// Scoreboard (includes mixed + event)
function recomputeScoreboard(){
  let winsA=0,winsB=0;

  for(const m of [...state.matchesM,...state.matchesF]){
    const code=winnerCode(m.scoreA,m.scoreB);
    if(code==="A") winsA++;
    if(code==="B") winsB++;
  }
  const mixCode = winnerCode(state.mixed?.scoreA, state.mixed?.scoreB);
  if(mixCode==="A") winsA++;
  if(mixCode==="B") winsB++;

  const evCode = winnerCode(state.event?.scoreA, state.event?.scoreB);
  if(evCode==="A") winsA++;
  if(evCode==="B") winsB++;

  $("winsA").textContent=winsA;
  $("winsB").textContent=winsB;

  let champ="â€”";
  if(winsA>winsB) champ="AíŒ€";
  else if(winsB>winsA) champ="BíŒ€";
  $("champion").textContent=champ;
}

// Disable binding for inputs on lock change
function bindScoreInputsDisabled(){
  bindMixedScore();
  bindEventScore();
}

// Event game
function renderEvent(){
  const A = state.event.A || [];
  const B = state.event.B || [];
  $("eventA").innerHTML = A.length ? A.map(p=>`<li>${label(p)} (${p.gender})</li>`).join("") : `<li class="text-slate-500">ë¯¸ìƒì„±</li>`;
  $("eventB").innerHTML = B.length ? B.map(p=>`<li>${label(p)} (${p.gender})</li>`).join("") : `<li class="text-slate-500">ë¯¸ìƒì„±</li>`;

  $("eventScoreA").value = state.event.scoreA ?? "";
  $("eventScoreB").value = state.event.scoreB ?? "";
  setEventWinnerPill(state.event.scoreA, state.event.scoreB);
}
function setEventWinnerPill(a,b){
  const code=winnerCode(a,b);
  $("eventWinnerPill").textContent = `ìŠ¹ë¦¬: ${winnerText(code)}`;
  $("eventWinnerPill").className = `px-4 py-2 rounded-2xl font-extrabold text-lg ${winnerPillClass(code)}`;
}
function bindEventScore(){
  const unlocked=isUnlocked();
  $("eventScoreA").disabled=!unlocked;
  $("eventScoreB").disabled=!unlocked;
  $("eventScoreA").classList.toggle("opacity-60", !unlocked);
  $("eventScoreB").classList.toggle("opacity-60", !unlocked);

  $("eventScoreA").oninput = (e)=>{
    if(!isUnlocked()) return;
    state.event.scoreA = e.target.value;
    setEventWinnerPill(state.event.scoreA, state.event.scoreB);
    recomputeScoreboard();
    saveStateDebounced();
  };
  $("eventScoreB").oninput = (e)=>{
    if(!isUnlocked()) return;
    state.event.scoreB = e.target.value;
    setEventWinnerPill(state.event.scoreA, state.event.scoreB);
    recomputeScoreboard();
    saveStateDebounced();
  };
}
function pickEventPlayers(){
  const A=shuffle(state.teamA.filter(p=>p.gender==="ë‚¨"||p.gender==="ì—¬")).slice(0,9);
  const B=shuffle(state.teamB.filter(p=>p.gender==="ë‚¨"||p.gender==="ì—¬")).slice(0,9);
  state.event.A=A; state.event.B=B;
  // ì ìˆ˜ëŠ” ìœ ì§€(ì›í•˜ë©´ ì—¬ê¸°ì„œ ì´ˆê¸°í™” ê°€ëŠ¥)
}

// Gift order
function renderGift(){
  $("giftWin").innerHTML = (state.gift.win||[]).length ? state.gift.win.map(p=>`<li>${label(p)} (${p.gender})</li>`).join("") : `<li class="text-slate-500">ë¯¸ìƒì„±</li>`;
  $("giftLose").innerHTML = (state.gift.lose||[]).length ? state.gift.lose.map(p=>`<li>${label(p)} (${p.gender})</li>`).join("") : `<li class="text-slate-500">ë¯¸ìƒì„±</li>`;
}
function makeGiftOrder(){
  const champ = $("champion").textContent;
  if(champ!=="AíŒ€" && champ!=="BíŒ€"){
    $("giftNote").textContent = "ìµœì¢… ìš°ìŠ¹ì´ ê²°ì •ëœ í›„(ì ìˆ˜ ì…ë ¥ í›„) ìˆœì„œë¥¼ ìƒì„±í•˜ì„¸ìš”.";
    state.gift={win:[],lose:[]};
    renderGift();
    return;
  }
  $("giftNote").textContent = "";
  const winTeam = champ==="AíŒ€" ? state.teamA : state.teamB;
  const loseTeam = champ==="AíŒ€" ? state.teamB : state.teamA;
  state.gift.win = shuffle(winTeam);
  state.gift.lose = shuffle(loseTeam);
  renderGift();
}

// Main render
function renderAll(){
  renderCounts();
  renderTeamLists();
  renderMatches();
  renderMixed();
  renderEvent();
  renderGift();
  recomputeScoreboard();
  applyLockUI();
}

// Buttons
$("btnPrint").addEventListener("click", ()=>window.print());

$("btnReset").addEventListener("click", ()=>{
  if(!confirm("ì´ ê¸°ê¸° ì €ì¥ëœ ëª…ë‹¨/ê²½ê¸°/ì ìˆ˜ê¹Œì§€ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  localStorage.removeItem(STORAGE_KEY_STATE);
  localStorage.removeItem(STORAGE_KEY_LOCK);
  state.people=[]; state.teamA=[]; state.teamB=[];
  state.matchesM=[]; state.matchesF=[];
  state.mixed={slots:null,scoreA:"",scoreB:""};
  state.event={A:[],B:[],scoreA:"",scoreB:""};
  state.gift={win:[],lose:[]};
  $("manualInput").value=""; $("removeInput").value="";
  $("addedManual").textContent="(ì—†ìŒ)";
  $("failedManual").textContent="(ì—†ìŒ)";
  $("removeResult").textContent="(ì—†ìŒ)";
  $("giftNote").textContent="";
  renderAll();
  alert("ì´ˆê¸°í™” ì™„ë£Œ");
});

// Excel upload
$("fileInput").addEventListener("change", async (e)=>{
  const file=e.target.files?.[0];
  if(!file) return;
  if(!isUnlocked()){ alert("ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); e.target.value=""; return; }
  try{
    const list=await loadExcelFile(file);
    state.people=dedupePeople([...state.people,...list]);
    saveStateDebounced();
    alert(`ì—…ë¡œë“œ ì™„ë£Œ: ${list.length}ëª…`);
    renderAll();
  }catch(err){
    console.error(err);
    alert("ì—‘ì…€ ì½ê¸° ì‹¤íŒ¨: íŒŒì¼ í˜•ì‹/ì‹œíŠ¸ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }finally{
    e.target.value="";
  }
});

$("btnClearPeople").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  state.people=[]; state.teamA=[]; state.teamB=[];
  state.matchesM=[]; state.matchesF=[];
  state.mixed={slots:null,scoreA:"",scoreB:""};
  state.event={A:[],B:[],scoreA:"",scoreB:""};
  state.gift={win:[],lose:[]};
  saveStateDebounced();
  renderAll();
});
$("btnNormalize").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  state.people=dedupePeople(state.people);
  saveStateDebounced();
  alert("ì¤‘ë³µ ì œê±° ì™„ë£Œ");
  renderAll();
});

// Manual add
$("btnAddManual").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  const {out,failed}=parseManualLines($("manualInput").value);
  state.people=dedupePeople([...state.people,...out]);
  $("addedManual").textContent = out.length ? out.map(p=>`${p.name} (${p.year}) ${p.gender}`).join("\n") : "(ì—†ìŒ)";
  $("failedManual").textContent = failed.length ? failed.join("\n") : "(ì—†ìŒ)";
  saveStateDebounced();
  renderAll();
});
$("btnClearManual").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  $("manualInput").value="";
  $("addedManual").textContent="(ì—†ìŒ)";
  $("failedManual").textContent="(ì—†ìŒ)";
});

// Manual remove
$("btnRemoveByName").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  const names=($("removeInput").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const {removed,notFound}=removeByNames(names);
  state.matchesM=[]; state.matchesF=[];
  state.mixed={slots:null,scoreA:"",scoreB:""};
  state.event={A:[],B:[],scoreA:"",scoreB:""};
  state.gift={win:[],lose:[]};

  $("removeResult").textContent = [`ì œì™¸ëœ ì¸ì›: ${removed}ëª…`, notFound.length?`ëª…ë‹¨ì— ì—†ë˜ ì´ë¦„: ${notFound.join(", ")}`:""].filter(Boolean).join("\n") || "(ì—†ìŒ)";
  if(state.teamA.length || state.teamB.length) assignTeamsCross();
  saveStateDebounced();
  renderAll();
});
$("btnClearRemove").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  $("removeInput").value="";
  $("removeResult").textContent="(ì—†ìŒ)";
});

// Assign teams
$("btnAssign").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  if(state.people.length<2){ alert("ëª…ë‹¨ì„ ë¨¼ì € ë„£ì–´ì£¼ì„¸ìš”."); return; }
  assignTeamsCross();
  state.matchesM=[]; state.matchesF=[];
  state.mixed={slots:null,scoreA:"",scoreB:""};
  state.event={A:[],B:[],scoreA:"",scoreB:""};
  state.gift={win:[],lose:[]};
  saveStateDebounced();
  renderAll();
});

// âœ… Make matches + Mixed 1
$("btnMakeMatches").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  if(!state.teamA.length && !state.teamB.length) assignTeamsCross();

  const mRes = makeStrictDoubles4("ë‚¨","M");
  const fRes = makeStrictDoubles4("ì—¬","F");
  state.matchesM = mRes.matches;
  state.matchesF = fRes.matches;

  // leftovers text
  const leftMtxt = `ë‚¨ì ë‚¨ëŠ” ì¸ì›: AíŒ€ ${mRes.leftA.length}ëª… / BíŒ€ ${mRes.leftB.length}ëª…`;
  const leftFtxt = `ì—¬ì ë‚¨ëŠ” ì¸ì›: AíŒ€ ${fRes.leftA.length}ëª… / BíŒ€ ${fRes.leftB.length}ëª…`;
  renderLeftovers(leftMtxt, leftFtxt);

  // mixed build
  const used = usedSetFromMatches();
  const leftAm = mRes.leftA;
  const leftBm = mRes.leftB;
  const leftAf = fRes.leftA;
  const leftBf = fRes.leftB;

  const totalLeft = leftAm.length+leftBm.length+leftAf.length+leftBf.length;

  if(totalLeft===0){
    // ë‚¨ëŠ” ì¸ì› ì—†ìœ¼ë©´ í˜¼ë³µì€ ì„ íƒì‚¬í•­ -> ì—¬ê¸°ì„œëŠ” "ì—†ìŒ"
    state.mixed = {slots:null, scoreA:"", scoreB:"", note:"ë‚¨ëŠ” ì¸ì›ì´ ì—†ì–´ í˜¼í•©ë³µì‹ì„ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."};
  } else {
    const built = buildMixedOneMatch(leftAm,leftAf,leftBm,leftBf, used);
    state.mixed = {slots: built.slots, scoreA:"", scoreB:"", note: built.note};
  }

  // event & gift keep (donâ€™t wipe)
  saveStateDebounced();
  renderAll();
});

// Event pick
$("btnEventPick").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  if(!state.teamA.length || !state.teamB.length){
    alert("ë¨¼ì € íŒ€ ë°°ì •(A/B)ì„ í•´ì£¼ì„¸ìš”.");
    return;
  }
  pickEventPlayers();
  saveStateDebounced();
  renderAll();
});

// Gift order
$("btnGiftOrder").addEventListener("click", ()=>{
  if(!isUnlocked()) return;
  makeGiftOrder();
  saveStateDebounced();
});

// Disable inputs when locked
function bindMixedEventOnInit(){
  bindMixedScore();
  bindEventScore();
}
bindMixedEventOnInit();

// Team drag changes reset matches already handled in setupTeamSortables()

// Initial load
loadStateFromStorage();
applyLockUI();
renderAll();
</script>
</body>
</html>
