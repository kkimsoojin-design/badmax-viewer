<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°°ë“œë§¥ìŠ¤ ì›”ë¡€ëŒ€íšŒ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- SortableJS (drag & drop) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    .watermark {
      position: fixed; inset: 0;
      pointer-events: none;
      z-index: 0;
      display: grid;
      place-items: center;
      opacity: 0.5; /* 50% */
      filter: grayscale(100%) blur(1px);
      transform: rotate(-10deg);
    }
    .watermark img { width: min(700px, 70vw); height: auto; }
    .content-layer { position: relative; z-index: 1; }

    /* ë·°ì–´ ëª¨ë“œì—ì„œ í´ë¦­/í¸ì§‘ ë°©ì§€ ìŠ¤íƒ€ì¼(ì…ë ¥ ë¹„í™œì„±ì€ JSì—ì„œ) */
    .locked-badge {
      background: rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(15, 23, 42, 0.12);
    }

    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      .print-card { box-shadow: none !important; border: 1px solid #e5e7eb !important; }
      input, textarea { border: 0 !important; background: transparent !important; }
      .watermark { opacity: 0.2; }
      details { border: 1px solid #e5e7eb !important; }
      summary { display:none !important; }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- ì›Œí„°ë§ˆí¬ -->
  <div class="watermark" id="watermark" style="display:none;">
    <img id="watermarkImg" alt="BADMAX watermark" />
  </div>

  <div class="content-layer max-w-6xl mx-auto p-3 sm:p-4 md:p-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div class="flex items-start gap-3">
        <div class="shrink-0">
          <img id="brandLogo" class="w-14 h-14 rounded-2xl object-contain bg-white border border-slate-200 shadow-sm p-1"
               alt="BADMAX Logo" />
        </div>
        <div class="min-w-0">
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight leading-tight">
            ë°°ë“œë§¥ìŠ¤ <span id="ymBadge" class="px-2 py-1 rounded-xl font-extrabold"></span> ì›”ë¡€ëŒ€íšŒ
          </h1>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <span id="modeBadge" class="locked-badge text-slate-800 text-xs font-bold px-2 py-1 rounded-xl">
              ğŸ”’ ë·°ì–´ ëª¨ë“œ(ì½ê¸° ì „ìš©)
            </span>
            <span class="text-xs text-slate-500">
              ìƒˆë¡œê³ ì¹¨í•´ë„ ëª…ë‹¨/ê²½ê¸°/ì ìˆ˜/ë¡œê³ ê°€ ìœ ì§€ë©ë‹ˆë‹¤(ì´ ê¸°ê¸°ì—ì„œ).
            </span>
          </div>
        </div>
      </div>

      <div class="no-print flex gap-2 flex-wrap">
        <!-- ê´€ë¦¬ì ì ê¸ˆ í•´ì œ -->
        <button id="btnUnlock" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold hover:bg-slate-800">
          ê´€ë¦¬ì ëª¨ë“œ
        </button>

        <!-- ë¡œê³ : ê¸°ë³¸ì€ ìˆ¨ê¹€(ë¡œê³  ì—†ì„ ë•Œë§Œ í‘œì‹œ), ê´€ë¦¬ìì—ì„œë§Œ ë³€ê²½ -->
        <label id="logoLabel" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100 cursor-pointer hidden">
          ë¡œê³ 
          <input id="logoInput" type="file" accept="image/*" class="hidden" />
        </label>

        <button id="btnPrint" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">
          ì¸ì‡„/ì¶œë ¥
        </button>

        <button id="btnReset" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">
          ì´ˆê¸°í™”
        </button>
      </div>
    </div>

    <!-- Upload + Current count -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-4">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">ì—‘ì…€ ì—…ë¡œë“œ</h2>

        <div class="no-print" data-admin-only>
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="w-full block p-2 border rounded-xl" />
          <div class="mt-3 flex gap-2 flex-wrap">
            <button id="btnClearPeople" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">
              ëª…ë‹¨ ë¹„ìš°ê¸°
            </button>
            <button id="btnNormalize" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">
              ì •ë¦¬(ì¤‘ë³µ ì œê±°)
            </button>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            * ë·°ì–´ëŠ” ì—…ë¡œë“œ ë¶ˆê°€. ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ì—…ë¡œë“œ/ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="mt-3 text-sm text-slate-600">
          í˜„ì¬ ì´ í˜ì´ì§€ëŠ” <b>ì •ì  í˜ì´ì§€(GitHub Pages)</b>ë¼ ì—…ë¡œë“œ íŒŒì¼ì„ ì„œë²„ì— ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>
          ëŒ€ì‹ , ì—…ë¡œë“œ ê²°ê³¼ë¥¼ <b>ì´ ê¸°ê¸° ë¸Œë¼ìš°ì €ì— ì €ì¥</b>í•´ì„œ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€í•©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">í˜„ì¬ ì¸ì›</h2>
        <div class="flex items-center justify-between">
          <div class="text-slate-600">ì „ì²´</div>
          <div id="countAll" class="text-3xl font-extrabold">0</div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-3">
          <div class="rounded-2xl border border-slate-200 p-3">
            <div class="text-slate-600 text-sm">ë‚¨</div>
            <div id="countM" class="text-2xl font-bold mt-1">0</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-3">
            <div class="text-slate-600 text-sm">ì—¬</div>
            <div id="countF" class="text-2xl font-bold mt-1">0</div>
          </div>
        </div>

        <div id="warnBox" class="mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-2 hidden"></div>

        <div class="mt-3 no-print grid grid-cols-1 gap-2" data-admin-only>
          <button id="btnAssign" class="w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-extrabold hover:bg-emerald-500">
            íŒ€ ë°°ì •(A/B)
          </button>
          <button id="btnMakeMatches" class="w-full px-4 py-3 rounded-2xl bg-indigo-600 text-white font-extrabold hover:bg-indigo-500">
            ê²½ê¸° ìƒì„±(ë‚¨ë³µ/ì—¬ë³µ/í˜¼ë³µ)
          </button>
        </div>
      </div>
    </div>

    <!-- Manual add/remove -->
    <div class="no-print grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-4" data-admin-only>
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">ìˆ˜ë™ ì¶”ê°€</h2>
        <textarea id="manualInput"
          class="w-full min-h-[110px] p-3 border rounded-2xl focus:outline-none focus:ring-2 focus:ring-slate-300"
          placeholder="ì˜ˆ) í™ê¸¸ë™ 1998 ë‚¨&#10;ê¹€ë¯¸ì†¡ 1991 ì—¬"></textarea>

        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnAddManual" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold hover:bg-slate-800">ì¶”ê°€</button>
          <button id="btnClearManual" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì…ë ¥ì¹¸ ë¹„ìš°ê¸°</button>
        </div>

        <div class="mt-3">
          <div class="text-sm font-bold text-slate-700 mb-1">ì¶”ê°€ëœ ì¸ì›</div>
          <pre id="addedManual" class="bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 whitespace-pre-wrap">(ì—†ìŒ)</pre>
        </div>

        <div class="mt-3">
          <div class="text-sm font-bold text-slate-700 mb-1">ì¶”ê°€ ì‹¤íŒ¨ ë¼ì¸</div>
          <pre id="failedManual" class="bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 whitespace-pre-wrap">(ì—†ìŒ)</pre>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="font-bold text-lg mb-2">ìˆ˜ë™ ì œê±°(ìš´ì˜ì§„ ì œì™¸ ë“±)</h2>
        <textarea id="removeInput"
          class="w-full min-h-[110px] p-3 border rounded-2xl focus:outline-none focus:ring-2 focus:ring-slate-300"
          placeholder="ì´ë¦„ë§Œ í•œ ì¤„ì”© ì…ë ¥&#10;ì˜ˆ) ê¹€ë¯¸ì†¡&#10;ë°°ì—°ìš°"></textarea>

        <div class="mt-3 flex gap-2 flex-wrap">
          <button id="btnRemoveByName" class="px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold hover:bg-rose-500">ëª…ë‹¨ì—ì„œ ì œì™¸</button>
          <button id="btnClearRemove" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ì…ë ¥ì¹¸ ë¹„ìš°ê¸°</button>
        </div>

        <div class="mt-3">
          <div class="text-sm font-bold text-slate-700 mb-1">ì œì™¸ ê²°ê³¼</div>
          <pre id="removeResult" class="bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 whitespace-pre-wrap">(ì—†ìŒ)</pre>
        </div>
      </div>
    </div>

    <!-- BIG Scoreboard -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-5 md:p-6 mb-4">
      <h2 class="font-extrabold text-xl md:text-2xl">ìµœì¢… ìŠ¤ì½”ì–´(ìŠ¹ìˆ˜)</h2>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
        <div class="rounded-3xl border border-slate-200 p-5 bg-slate-50 text-center">
          <div class="text-slate-600 text-sm">AíŒ€ ìŠ¹</div>
          <div id="winsA" class="text-5xl font-extrabold mt-2">0</div>
        </div>

        <div class="rounded-3xl border border-slate-200 p-5 bg-slate-900 text-white text-center">
          <div class="text-sm opacity-80">ìµœì¢… ìš°ìŠ¹</div>
          <div id="champion" class="text-4xl md:text-5xl font-extrabold mt-2">â€”</div>
        </div>

        <div class="rounded-3xl border border-slate-200 p-5 bg-slate-50 text-center">
          <div class="text-slate-600 text-sm">BíŒ€ ìŠ¹</div>
          <div id="winsB" class="text-5xl font-extrabold mt-2">0</div>
        </div>
      </div>
    </div>

    <!-- Teams (draggable) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-4">
      <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between">
          <h2 class="font-extrabold text-lg">AíŒ€ ëª…ë‹¨</h2>
          <span id="countA" class="text-sm text-slate-600">0ëª…</span>
        </div>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ë‚¨ì</div>
            <ul id="teamA_m" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ì—¬ì</div>
            <ul id="teamA_f" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
        </div>

        <div class="no-print mt-2 text-xs text-slate-500" data-admin-only>
          * ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ë“œë˜ê·¸ ì´ë™/ìˆ˜ì • ê°€ëŠ¥
        </div>
      </div>

      <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between">
          <h2 class="font-extrabold text-lg">BíŒ€ ëª…ë‹¨</h2>
          <span id="countB" class="text-sm text-slate-600">0ëª…</span>
        </div>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ë‚¨ì</div>
            <ul id="teamB_m" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
          <div class="rounded-2xl border border-slate-200 p-3 bg-slate-50">
            <div class="text-sm font-bold text-slate-700 mb-2">ì—¬ì</div>
            <ul id="teamB_f" class="team-list flex flex-col gap-2 min-h-[48px]"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Matches -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="font-extrabold text-lg">ê²½ê¸°í‘œ</h2>
        <div class="no-print flex gap-2 flex-wrap" data-admin-only>
          <button id="btnExportJson" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ê¸°ë¡ ì €ì¥</button>
          <button id="btnImportJson" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-semibold hover:bg-slate-100">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <input id="jsonFile" type="file" accept="application/json" class="hidden" />
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold text-slate-800 mb-2">ë‚¨ì ë³µì‹(4ì¸)</h3>
          <div id="matchesM" class="flex flex-col gap-3"></div>
        </div>
        <div>
          <h3 class="font-bold text-slate-800 mb-2">ì—¬ì ë³µì‹(4ì¸)</h3>
          <div id="matchesF" class="flex flex-col gap-3"></div>
        </div>
      </div>
    </div>

    <!-- Mixed -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
      <h2 class="font-extrabold text-lg">í˜¼í•© ë³µì‹(ë‚¨ì€ ì¸ì› ì²˜ë¦¬)</h2>
      <div class="mt-3" id="matchesX" class="flex flex-col gap-3"></div>
    </div>

    <!-- Event: collapsible -->
    <details class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-4">
      <summary class="no-print cursor-pointer font-extrabold text-lg select-none">ì´ë²¤íŠ¸ ê²½ê¸° (í¼ì¹˜ê¸°/ì ‘ê¸°)</summary>

      <div class="mt-3 flex items-center justify-between flex-wrap gap-2">
        <h2 class="font-extrabold text-lg">ì•‰ì€ë±…ì´ ë¯¼í„´</h2>
        <button id="btnSitminton" class="no-print px-4 py-2 rounded-2xl bg-amber-500 text-white font-extrabold hover:bg-amber-400" data-admin-only>
          ëœë¤ 9:9 ìƒì„±
        </button>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold">AíŒ€ ëœë¤ 9ëª…</div>
          <div id="sitA" class="mt-2 text-sm whitespace-pre-wrap">â€”</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold">BíŒ€ ëœë¤ 9ëª…</div>
          <div id="sitB" class="mt-2 text-sm whitespace-pre-wrap">â€”</div>
        </div>
      </div>

      <div class="mt-3 rounded-2xl border border-slate-200 bg-white p-3">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div class="font-extrabold">ì ìˆ˜ (15ì  ì„ ìŠ¹)</div>
          <div id="sitWinner" class="px-4 py-2 rounded-2xl font-extrabold text-lg bg-slate-200 text-slate-800">
            ìŠ¹ë¦¬: â€”
          </div>
        </div>

        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2" data-admin-only>
          <div>
            <label class="text-xs text-slate-600">A ì ìˆ˜</label>
            <input id="sitScoreA" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric" placeholder="ì˜ˆ: 15" />
          </div>
          <div>
            <label class="text-xs text-slate-600">B ì ìˆ˜</label>
            <input id="sitScoreB" class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" inputmode="numeric" placeholder="ì˜ˆ: 12" />
          </div>
        </div>
      </div>
    </details>

    <!-- Gift order generator -->
    <div class="print-card bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <h2 class="font-extrabold text-lg">ì„ ë¬¼ ë°°ë¶„ìš© ìˆœì„œ</h2>
        <button id="btnMakeOrder" class="no-print px-4 py-2 rounded-2xl bg-fuchsia-600 text-white font-extrabold hover:bg-fuchsia-500" data-admin-only>
          ìˆœì„œ ìƒì„±í•˜ê¸°
        </button>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold">ìŠ¹ë¦¬íŒ€ ìˆœì„œ</div>
          <div id="orderWin" class="mt-2 text-sm whitespace-pre-wrap">â€”</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
          <div class="font-bold">íŒ¨ë°°íŒ€ ìˆœì„œ</div>
          <div id="orderLose" class="mt-2 text-sm whitespace-pre-wrap">â€”</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // =========================
    // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
    // =========================
    const ADMIN_PASSWORD = "badmax!2025"; // ì›í•˜ì‹œëŠ” ë¹„ë²ˆìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.

    // =========================
    // localStorage í‚¤
    // =========================
    const STORAGE_KEY_STATE = "badmax_state_v5";
    const STORAGE_KEY_LOGO  = "badmax_logo_v1";
    const STORAGE_KEY_LOCK  = "badmax_admin_unlocked_v1";

    // =========================
    // ì œëª© ì—°/ì›” ìë™
    // =========================
    function setYearMonthTitle() {
      const d = new Date();
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const badge = `${y}ë…„ ${m}ì›”`;
      const el = $("ymBadge");
      el.textContent = badge;
      el.className = "px-2 py-1 rounded-xl font-extrabold bg-indigo-600 text-white";
      document.title = `ë°°ë“œë§¥ìŠ¤ ${badge} ì›”ë¡€ëŒ€íšŒ`;
    }
    setYearMonthTitle();

    // =========================
    // State
    // =========================
    const state = {
      people: [],
      teamA: [],
      teamB: [],
      matchesM: [],
      matchesF: [],
      matchesX: [],
      sit: { A: [], B: [], scoreA: "", scoreB: "" }
    };

    // =========================
    // Lock / Unlock (ë·°ì–´ / ê´€ë¦¬ì)
    // =========================
    function isUnlocked() {
      return localStorage.getItem(STORAGE_KEY_LOCK) === "1";
    }

    function setUnlocked(v) {
      localStorage.setItem(STORAGE_KEY_LOCK, v ? "1" : "0");
      applyLockUI();
    }

    function applyLockUI() {
      const unlocked = isUnlocked();
      const badge = $("modeBadge");
      const btn = $("btnUnlock");

      if (unlocked) {
        badge.textContent = "âœ… ê´€ë¦¬ì ëª¨ë“œ(í¸ì§‘ ê°€ëŠ¥)";
        badge.className = "text-xs font-bold px-2 py-1 rounded-xl bg-emerald-600 text-white";
        btn.textContent = "ê´€ë¦¬ì ì ê¸ˆ";
      } else {
        badge.textContent = "ğŸ”’ ë·°ì–´ ëª¨ë“œ(ì½ê¸° ì „ìš©)";
        badge.className = "locked-badge text-slate-800 text-xs font-bold px-2 py-1 rounded-xl";
        btn.textContent = "ê´€ë¦¬ì ëª¨ë“œ";
      }

      // ê´€ë¦¬ì ì „ìš© ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€ + ì…ë ¥ ë¹„í™œì„±í™”
      document.querySelectorAll("[data-admin-only]").forEach(el => {
        // í™”ë©´ì—ì„œ ì™„ì „ ìˆ¨ê¸°ë©´ ì‚¬ìš©ì„± ì¢‹ìŒ
        el.style.display = unlocked ? "" : "none";
      });

      // ë¡œê³  ì—…ë¡œë“œëŠ”:
      // - ë¡œê³ ê°€ ì—†ìœ¼ë©´(ì´ˆê¸° 1íšŒ) ëˆ„êµ¬ë‚˜ ë„£ì„ ìˆ˜ ìˆê²Œ ë³´ì´ë˜,
      // - ë¡œê³ ê°€ ìˆìœ¼ë©´ ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥.
      const hasLogo = !!localStorage.getItem(STORAGE_KEY_LOGO);
      const logoLabel = $("logoLabel");
      if (!hasLogo) {
        logoLabel.classList.remove("hidden"); // ì²« ì„¸íŒ…
      } else {
        logoLabel.classList.toggle("hidden", !unlocked); // ë³€ê²½ì€ ê´€ë¦¬ìë§Œ
      }

      // ì ìˆ˜ ì…ë ¥ë„ ê´€ë¦¬ìë§Œ
      document.querySelectorAll("input.scoreA, input.scoreB").forEach(inp => {
        inp.disabled = !unlocked;
        inp.classList.toggle("opacity-60", !unlocked);
      });

      // ë“œë˜ê·¸ë„ ê´€ë¦¬ìë§Œ (SortableëŠ” ì•„ë˜ì—ì„œ unlockedì— ë§ê²Œ ìƒì„±)
      setupTeamSortables();
    }

    $("btnUnlock").addEventListener("click", () => {
      if (isUnlocked()) {
        setUnlocked(false);
        return;
      }
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (pw === null) return;
      if (pw === ADMIN_PASSWORD) {
        setUnlocked(true);
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    });

    // =========================
    // ë¡œê³ : 1íšŒ ì—…ë¡œë“œ í›„ ì €ì¥(ìƒˆë¡œê³ ì¹¨ì—ë„ ìœ ì§€)
    // =========================
    function setLogoDataUrl(dataUrl) {
      $("brandLogo").src = dataUrl || "";
      $("watermarkImg").src = dataUrl || "";
      $("watermark").style.display = dataUrl ? "grid" : "none";
    }

    async function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    $("logoInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      // ë¡œê³ ê°€ ì´ë¯¸ ì €ì¥ë¼ ìˆê³ , ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ˆë©´ ë³€ê²½ ë¶ˆê°€
      const hasLogo = !!localStorage.getItem(STORAGE_KEY_LOGO);
      if (hasLogo && !isUnlocked()) {
        alert("ë¡œê³  ë³€ê²½ì€ ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        e.target.value = "";
        return;
      }

      const dataUrl = await fileToDataUrl(file);
      localStorage.setItem(STORAGE_KEY_LOGO, dataUrl);
      setLogoDataUrl(dataUrl);
      applyLockUI();
      e.target.value = "";
    });

    // =========================
    // localStorage ì €ì¥/ë³µì›
    // =========================
    let saveTimer = null;
    function saveStateDebounced() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        try {
          localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(state));
        } catch (e) {
          console.error(e);
          alert("ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ì €ì¥ì†Œ)");
        }
      }, 250);
    }

    function loadStateFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY_STATE);
      if (raw) {
        try {
          const data = JSON.parse(raw);
          state.people = data.people || [];
          state.teamA = data.teamA || [];
          state.teamB = data.teamB || [];
          state.matchesM = data.matchesM || [];
          state.matchesF = data.matchesF || [];
          state.matchesX = data.matchesX || [];
          state.sit = data.sit || { A: [], B: [], scoreA: "", scoreB: "" };
        } catch (e) {
          console.warn("state parse fail", e);
        }
      }
      const logo = localStorage.getItem(STORAGE_KEY_LOGO);
      if (logo) setLogoDataUrl(logo);
    }

    // =========================
    // Utils
    // =========================
    function normGender(g) {
      const s = (g ?? "").toString().trim().toUpperCase();
      if (["ë‚¨","ë‚¨ì","M","MALE"].includes(s)) return "ë‚¨";
      if (["ì—¬","ì—¬ì","F","FEMALE"].includes(s)) return "ì—¬";
      return "ë¯¸ì •";
    }
    function keyOf(p) { return `${p.name}|${p.year}|${p.gender}`; }
    function dedupePeople(list) {
      const seen = new Set(); const res = [];
      for (const p of list) {
        const k = keyOf(p);
        if (!seen.has(k)) { seen.add(k); res.push(p); }
      }
      return res;
    }
    function sortByElderFirst(list) {
      return [...list].sort((a,b) => (a.year - b.year) || a.name.localeCompare(b.name));
    }
    function countByGender(list) {
      let m=0,f=0,u=0;
      for (const p of list) {
        if (p.gender==="ë‚¨") m++;
        else if (p.gender==="ì—¬") f++;
        else u++;
      }
      return {m,f,u};
    }
    function shuffle(arr) {
      const a = [...arr];
      for (let i=a.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    const THEMES = [
      "bg-gradient-to-br from-sky-50 to-white border-sky-100",
      "bg-gradient-to-br from-emerald-50 to-white border-emerald-100",
      "bg-gradient-to-br from-indigo-50 to-white border-indigo-100",
      "bg-gradient-to-br from-rose-50 to-white border-rose-100",
      "bg-gradient-to-br from-amber-50 to-white border-amber-100",
      "bg-gradient-to-br from-violet-50 to-white border-violet-100",
      "bg-gradient-to-br from-cyan-50 to-white border-cyan-100",
      "bg-gradient-to-br from-lime-50 to-white border-lime-100",
    ];

    // =========================
    // Manual Add / Remove
    // =========================
    function parseManualLines(text) {
      const lines = (text || "").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const out = [];
      const failed = [];
      const re = /^(.+?)\s+(\d{4})\s+(ë‚¨|ì—¬|ë‚¨ì|ì—¬ì|M|F)\s*$/i;

      for (const line of lines) {
        const m = line.match(re);
        if (!m) { failed.push(line); continue; }
        const name = m[1].trim();
        const year = parseInt(m[2],10);
        const gender = normGender(m[3]);
        if (!(year >= 1900 && year <= 2099)) { failed.push(line + "  (ì—°ë„ ë²”ìœ„ ì˜¤ë¥˜)"); continue; }
        if (gender === "ë¯¸ì •") { failed.push(line + "  (ì„±ë³„ ì¸ì‹ ì‹¤íŒ¨)"); continue; }
        out.push({ name, year, gender });
      }
      return { out, failed };
    }

    function removeByNames(names) {
      const set = new Set(names.map(n => n.trim()).filter(Boolean));
      if (!set.size) return { removed: 0, notFound: [] };

      const before = state.people.length;
      const existedNames = new Set(state.people.map(p => p.name));

      state.people = state.people.filter(p => !set.has(p.name));
      state.teamA = state.teamA.filter(p => !set.has(p.name));
      state.teamB = state.teamB.filter(p => !set.has(p.name));

      const after = state.people.length;
      const removed = before - after;
      const notFound = [...set].filter(n => !existedNames.has(n));
      return { removed, notFound };
    }

    // =========================
    // Excel parsing
    // =========================
    function guessColumn(headers, candidates) {
      const lower = headers.map(h => (h ?? "").toString().trim().toLowerCase());
      for (const cand of candidates) {
        const idx = lower.findIndex(h => h.includes(cand));
        if (idx !== -1) return idx;
      }
      return -1;
    }

    async function loadExcelFile(file) {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type: "array" });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      if (!rows.length) return [];

      const headers = rows[0].map(x => x.toString());
      const idxName = guessColumn(headers, ["ì´ë¦„","ì„±ëª…","name"]);
      const idxYear = guessColumn(headers, ["ì¶œìƒì—°ë„","ì¶œìƒ","year","birth","ë…„ë„"]);
      const idxGender = guessColumn(headers, ["ì„±ë³„","ë‚¨ì—¬","gender","sex"]);

      const nI = idxName !== -1 ? idxName : 0;
      const yI = idxYear !== -1 ? idxYear : 1;
      const gI = idxGender !== -1 ? idxGender : 2;

      const out = [];
      for (let r=1; r<rows.length; r++) {
        const row = rows[r];
        const name = (row[nI] ?? "").toString().trim();
        if (!name) continue;

        const year = parseInt((row[yI] ?? "").toString().trim(), 10);
        const gender = normGender((row[gI] ?? "").toString().trim());

        out.push({ name, year, gender });
      }
      return out;
    }

    // =========================
    // Team assignment
    // =========================
    function assignTeamsCross() {
      const all = dedupePeople(state.people).filter(p => p.gender==="ë‚¨" || p.gender==="ì—¬");
      const males = sortByElderFirst(all.filter(p=>p.gender==="ë‚¨"));
      const females = sortByElderFirst(all.filter(p=>p.gender==="ì—¬"));

      const A=[], B=[];
      let toggle = true;
      for (const p of males) { (toggle ? A : B).push(p); toggle = !toggle; }
      for (const p of females) { (toggle ? A : B).push(p); toggle = !toggle; }

      state.teamA = A;
      state.teamB = B;
    }

    // =========================
    // Winner
    // =========================
    function winnerCode(scoreA, scoreB) {
      const a = parseInt(scoreA,10);
      const b = parseInt(scoreB,10);
      if (!Number.isFinite(a) || !Number.isFinite(b)) return "";
      if (a > b) return "A";
      if (b > a) return "B";
      return "D";
    }
    function winnerText(code) {
      if (code === "A") return "AíŒ€";
      if (code === "B") return "BíŒ€";
      if (code === "D") return "ë¬´ìŠ¹ë¶€";
      return "â€”";
    }
    function winnerPillClass(code) {
      if (code === "A") return "bg-emerald-600 text-white";
      if (code === "B") return "bg-blue-600 text-white";
      if (code === "D") return "bg-slate-600 text-white";
      return "bg-slate-200 text-slate-800";
    }

    // =========================
    // Match generation (4ëª… ë¯¸ë§Œ ê²½ê¸° ê¸ˆì§€ + ì”ì—¬ ì¸ì› í˜¼ë³µ 1ê²½ê¸° ì²˜ë¦¬)
    // =========================
    function makeStrictDoubles4(gender, themeStart=0, prefix="M") {
      const A = sortByElderFirst(state.teamA.filter(p=>p.gender===gender));
      const B = sortByElderFirst(state.teamB.filter(p=>p.gender===gender));
      const matches = [];
      let i=1, theme=themeStart;

      while (A.length >= 2 && B.length >= 2) {
        const slots = [A.shift(), A.shift(), B.shift(), B.shift()];
        matches.push({ id: `${prefix}-${i++}`, type: prefix, themeIdx: (theme++ % THEMES.length), slots, scoreA:"", scoreB:"" });
      }
      return { matches, leftoverA: A, leftoverB: B };
    }

    function allParticipants() { return [...state.teamA, ...state.teamB]; }
    function usedInMatches(matches) {
      const used = new Set();
      for (const m of matches) for (const p of (m.slots||[])) used.add(keyOf(p));
      return used;
    }

    function makeMixedFromRemainders(remainders, alreadyUsedSet, themeStart=0) {
      const matches = [];
      let theme = themeStart, idx=1;

      const remA = remainders.filter(p => state.teamA.some(x => keyOf(x)===keyOf(p)));
      const remB = remainders.filter(p => state.teamB.some(x => keyOf(x)===keyOf(p)));

      let poolA = shuffle(remA);
      let poolB = shuffle(remB);

      const played = allParticipants().filter(p => alreadyUsedSet.has(keyOf(p)));
      const playedA = shuffle(played.filter(p => state.teamA.some(x => keyOf(x)===keyOf(p))));
      const playedB = shuffle(played.filter(p => state.teamB.some(x => keyOf(x)===keyOf(p))));

      function take2(pool, fallback) {
        const res = [];
        while (res.length < 2 && pool.length) res.push(pool.shift());
        while (res.length < 2 && fallback.length) res.push(fallback.shift());
        return res;
      }

      while (poolA.length >= 2 && poolB.length >= 2) {
        const a2 = take2(poolA, []);
        const b2 = take2(poolB, []);
        matches.push({ id:`X-${idx++}`, type:"X", themeIdx:(theme++ % THEMES.length), slots:[a2[0],a2[1],b2[0],b2[1]], scoreA:"", scoreB:"" });
      }

      const leftoverA = poolA;
      const leftoverB = poolB;
      const totalLeft = leftoverA.length + leftoverB.length;

      if (totalLeft > 0) {
        const needA = Math.max(0, 2 - leftoverA.length);
        const needB = Math.max(0, 2 - leftoverB.length);

        const aPicked = [...leftoverA, ...playedA.splice(0, needA)].slice(0, 2);
        const bPicked = [...leftoverB, ...playedB.splice(0, needB)].slice(0, 2);

        if (aPicked.length === 2 && bPicked.length === 2) {
          matches.push({ id:`X-${idx++}`, type:"X", themeIdx:(theme++ % THEMES.length), slots:[aPicked[0],aPicked[1],bPicked[0],bPicked[1]], scoreA:"", scoreB:"" });
        }
      }
      return matches;
    }

    function regenerateMatches() {
      const m = makeStrictDoubles4("ë‚¨", 0, "M");
      state.matchesM = m.matches;

      const f = makeStrictDoubles4("ì—¬", state.matchesM.length, "F");
      state.matchesF = f.matches;

      const leftovers = [...m.leftoverA, ...m.leftoverB, ...f.leftoverA, ...f.leftoverB];
      const used = new Set([...usedInMatches(state.matchesM), ...usedInMatches(state.matchesF)]);
      state.matchesX = makeMixedFromRemainders(leftovers, used, state.matchesM.length + state.matchesF.length);

      renderMatches();
      recomputeScoreboard();
      saveStateDebounced();
    }

    // =========================
    // Render counts / teams
    // =========================
    function renderCounts() {
      state.people = dedupePeople(state.people);
      const {m,f,u} = countByGender(state.people);
      $("countAll").textContent = state.people.length;
      $("countM").textContent = m;
      $("countF").textContent = f;

      const warn = [];
      if (u > 0) warn.push(`ì„±ë³„ ë¯¸ì • ${u}ëª…(ì •ë¦¬ í•„ìš”)`);
      if (state.people.length === 0) warn.push("ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
      $("warnBox").textContent = warn.join(" / ");
      $("warnBox").classList.toggle("hidden", warn.length===0);
    }

    function emptyLi() {
      return `<li class="text-sm text-slate-500 px-3 py-2 rounded-xl border border-dashed border-slate-200 bg-white">(ë¹„ì–´ìˆìŒ)</li>`;
    }

    function teamLi(p, idx) {
      const badge = p.gender==="ë‚¨"
        ? "bg-sky-50 text-sky-700 border-sky-200"
        : "bg-pink-50 text-pink-700 border-pink-200";
      return `
        <li class="team-item flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white cursor-grab active:cursor-grabbing"
            data-name="${p.name}" data-year="${p.year}" data-gender="${p.gender}">
          <div class="min-w-0">
            <div class="font-semibold truncate">
              <span class="text-slate-500 mr-2">${idx}.</span>${p.name}
              <span class="text-slate-400">(${p.year})</span>
            </div>
          </div>
          <span class="text-xs px-2 py-1 rounded-full border ${badge}">${p.gender}</span>
        </li>
      `;
    }

    function renderTeamLists() {
      $("countA").textContent = `${state.teamA.length}ëª…`;
      $("countB").textContent = `${state.teamB.length}ëª…`;

      const Am = sortByElderFirst(state.teamA.filter(p=>p.gender==="ë‚¨"));
      const Af = sortByElderFirst(state.teamA.filter(p=>p.gender==="ì—¬"));
      const Bm = sortByElderFirst(state.teamB.filter(p=>p.gender==="ë‚¨"));
      const Bf = sortByElderFirst(state.teamB.filter(p=>p.gender==="ì—¬"));

      $("teamA_m").innerHTML = Am.length ? Am.map((p,i)=>teamLi(p, i+1)).join("") : emptyLi();
      $("teamA_f").innerHTML = Af.length ? Af.map((p,i)=>teamLi(p, i+1)).join("") : emptyLi();
      $("teamB_m").innerHTML = Bm.length ? Bm.map((p,i)=>teamLi(p, i+1)).join("") : emptyLi();
      $("teamB_f").innerHTML = Bf.length ? Bf.map((p,i)=>teamLi(p, i+1)).join("") : emptyLi();

      setupTeamSortables();
    }

    function setupTeamSortables() {
      const unlocked = isUnlocked();
      const lists = ["teamA_m","teamA_f","teamB_m","teamB_f"].map(id => document.getElementById(id));

      for (const ul of lists) {
        if (ul._sortable) ul._sortable.destroy();
        if (!unlocked) continue;

        ul._sortable = new Sortable(ul, {
          group: "teams",
          animation: 150,
          ghostClass: "opacity-50",
          onEnd: () => {
            syncTeamsFromDOM();
            if (state.matchesM.length || state.matchesF.length || state.matchesX.length) {
              regenerateMatches();
            } else {
              renderTeamLists();
              saveStateDebounced();
            }
          }
        });
      }
    }

    function syncTeamsFromDOM() {
      const readList = (id) => {
        const ul = document.getElementById(id);
        const items = Array.from(ul.querySelectorAll("li.team-item"));
        const res = [];
        for (const li of items) {
          const name = li.dataset.name;
          const year = parseInt(li.dataset.year,10);
          const gender = li.dataset.gender;
          if (name && Number.isFinite(year) && (gender==="ë‚¨"||gender==="ì—¬")) res.push({ name, year, gender });
        }
        return res;
      };

      const A = [...readList("teamA_m"), ...readList("teamA_f")];
      const B = [...readList("teamB_m"), ...readList("teamB_f")];

      state.teamA = sortByElderFirst(A.filter(p=>p.gender==="ë‚¨")).concat(sortByElderFirst(A.filter(p=>p.gender==="ì—¬")));
      state.teamB = sortByElderFirst(B.filter(p=>p.gender==="ë‚¨")).concat(sortByElderFirst(B.filter(p=>p.gender==="ì—¬")));

      renderTeamLists();
      saveStateDebounced();
    }

    // =========================
    // Match cards
    // =========================
    function matchCard(m) {
      const theme = THEMES[m.themeIdx % THEMES.length];
      const code = winnerCode(m.scoreA, m.scoreB);
      const pill = winnerPillClass(code);
      const wt = winnerText(code);
      const label = (p) => `${p.name} (${p.year})`;

      return `
        <div class="rounded-2xl border ${theme} p-3">
          <div class="flex items-start justify-between gap-2">
            <div class="font-extrabold">ê²½ê¸° ${m.id}</div>
            <div id="winbox-${m.id}" class="px-4 py-2 rounded-2xl font-extrabold text-lg ${pill}">
              ìŠ¹ë¦¬: <span id="winner-${m.id}">${wt}</span>
            </div>
          </div>

          <ul class="mt-2 flex flex-col gap-2">
            ${[0,1,2,3].map(i => `
              <li class="flex items-center justify-between gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white">
                <div class="font-semibold truncate">${label(m.slots[i])}</div>
                <span class="text-xs text-slate-500">${i<2 ? "AíŒ€" : "BíŒ€"}</span>
              </li>
            `).join("")}
          </ul>

          <div class="mt-3 grid grid-cols-2 gap-2 items-center">
            <div>
              <label class="text-xs text-slate-600">A ì ìˆ˜</label>
              <input class="scoreA w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"
                     inputmode="numeric" placeholder="ì˜ˆ: 21" value="${m.scoreA ?? ''}"
                     data-matchid="${m.id}" />
            </div>
            <div>
              <label class="text-xs text-slate-600">B ì ìˆ˜</label>
              <input class="scoreB w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"
                     inputmode="numeric" placeholder="ì˜ˆ: 18" value="${m.scoreB ?? ''}"
                     data-matchid="${m.id}" />
            </div>
          </div>
        </div>
      `;
    }

    function findMatchById(id) {
      return [...state.matchesM, ...state.matchesF, ...state.matchesX].find(x => x.id === id);
    }

    function updateWinnerUI(m) {
      const code = winnerCode(m.scoreA, m.scoreB);
      const wt = winnerText(code);
      const box = document.getElementById(`winbox-${m.id}`);
      const span = document.getElementById(`winner-${m.id}`);
      if (span) span.textContent = wt;
      if (box) box.className = `px-4 py-2 rounded-2xl font-extrabold text-lg ${winnerPillClass(code)}`;
    }

    function renderMatches() {
      $("matchesM").innerHTML = state.matchesM.map(matchCard).join("");
      $("matchesF").innerHTML = state.matchesF.map(matchCard).join("");
      $("matchesX").innerHTML = state.matchesX.map(matchCard).join("");

      document.querySelectorAll("input.scoreA").forEach(inp => {
        inp.addEventListener("input", (e) => {
          const id = e.target.dataset.matchid;
          const m = findMatchById(id);
          if (!m) return;
          m.scoreA = e.target.value;
          updateWinnerUI(m);
          recomputeScoreboard();
          saveStateDebounced();
        });
      });
      document.querySelectorAll("input.scoreB").forEach(inp => {
        inp.addEventListener("input", (e) => {
          const id = e.target.dataset.matchid;
          const m = findMatchById(id);
          if (!m) return;
          m.scoreB = e.target.value;
          updateWinnerUI(m);
          recomputeScoreboard();
          saveStateDebounced();
        });
      });

      applyLockUI(); // ì ìˆ˜ ì…ë ¥ ë¹„í™œì„± ë°˜ì˜
    }

    function recomputeScoreboard() {
      const all = [...state.matchesM, ...state.matchesF, ...state.matchesX];
      let winsA = 0, winsB = 0;
      for (const m of all) {
        const code = winnerCode(m.scoreA, m.scoreB);
        if (code === "A") winsA++;
        if (code === "B") winsB++;
      }
      const sitCode = winnerCode(state.sit.scoreA, state.sit.scoreB);
      if (sitCode === "A") winsA++;
      if (sitCode === "B") winsB++;

      $("winsA").textContent = winsA;
      $("winsB").textContent = winsB;

      let champ = "â€”";
      if (winsA > winsB) champ = "AíŒ€";
      else if (winsB > winsA) champ = "BíŒ€";
      $("champion").textContent = champ;
    }

    // =========================
    // ì´ë²¤íŠ¸ ê²½ê¸°
    // =========================
    function renderSit() {
      $("sitA").textContent = (state.sit.A.map(p => p.name).join("\n")) || "â€”";
      $("sitB").textContent = (state.sit.B.map(p => p.name).join("\n")) || "â€”";
      const code = winnerCode(state.sit.scoreA, state.sit.scoreB);
      $("sitWinner").textContent = `ìŠ¹ë¦¬: ${winnerText(code)}`;
      $("sitWinner").className = `px-4 py-2 rounded-2xl font-extrabold text-lg ${winnerPillClass(code)}`;
    }

    function makeSitminton() {
      const A = shuffle(state.teamA);
      const B = shuffle(state.teamB);
      state.sit.A = A.slice(0, 9);
      state.sit.B = B.slice(0, 9);
      state.sit.scoreA = "";
      state.sit.scoreB = "";
      $("sitScoreA").value = "";
      $("sitScoreB").value = "";
      renderSit();
      recomputeScoreboard();
      saveStateDebounced();
    }

    // =========================
    // ì„ ë¬¼ ìˆœì„œ
    // =========================
    function renderOrders(winList, loseList) {
      $("orderWin").textContent = winList.length ? winList.map((n,i)=>`${i+1}. ${n}`).join("\n") : "â€”";
      $("orderLose").textContent = loseList.length ? loseList.map((n,i)=>`${i+1}. ${n}`).join("\n") : "â€”";
    }

    function makeGiftOrder() {
      const champ = $("champion").textContent.trim();
      if (champ !== "AíŒ€" && champ !== "BíŒ€") {
        alert("ë¨¼ì € ì ìˆ˜ë¥¼ ì…ë ¥í•´ì„œ ìµœì¢… ìš°ìŠ¹íŒ€ì„ í™•ì •í•´ì£¼ì„¸ìš”.");
        return;
      }
      const winTeam = champ === "AíŒ€" ? state.teamA : state.teamB;
      const loseTeam = champ === "AíŒ€" ? state.teamB : state.teamA;

      renderOrders(shuffle(winTeam.map(p=>p.name)), shuffle(loseTeam.map(p=>p.name)));
      saveStateDebounced();
    }

    // =========================
    // Render All
    // =========================
    function renderAll() {
      renderCounts();
      renderTeamLists();
      renderMatches();
      renderSit();
      recomputeScoreboard();
      applyLockUI();
    }

    // =========================
    // ë²„íŠ¼/ì´ë²¤íŠ¸
    // =========================
    $("btnPrint").addEventListener("click", () => window.print());

    $("btnReset").addEventListener("click", () => {
      if (!confirm("ì´ ê¸°ê¸° ì €ì¥ëœ ëª…ë‹¨/ê²½ê¸°/ì ìˆ˜/ë¡œê³ ê¹Œì§€ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      localStorage.removeItem(STORAGE_KEY_STATE);
      localStorage.removeItem(STORAGE_KEY_LOGO);
      localStorage.removeItem(STORAGE_KEY_LOCK);

      state.people = [];
      state.teamA = [];
      state.teamB = [];
      state.matchesM = [];
      state.matchesF = [];
      state.matchesX = [];
      state.sit = { A: [], B: [], scoreA: "", scoreB: "" };

      $("manualInput") && ($("manualInput").value = "");
      $("removeInput") && ($("removeInput").value = "");
      $("fileInput").value = "";
      $("addedManual") && ($("addedManual").textContent = "(ì—†ìŒ)");
      $("failedManual") && ($("failedManual").textContent = "(ì—†ìŒ)");
      $("removeResult") && ($("removeResult").textContent = "(ì—†ìŒ)");
      $("orderWin").textContent = "â€”";
      $("orderLose").textContent = "â€”";

      setLogoDataUrl("");
      renderAll();
      alert("ì´ˆê¸°í™” ì™„ë£Œ");
    });

    $("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (!isUnlocked()) { alert("ë·°ì–´ ëª¨ë“œì—ì„œëŠ” ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); e.target.value=""; return; }

      try {
        const list = await loadExcelFile(file);
        state.people = dedupePeople([...state.people, ...list]);
        renderCounts();
        saveStateDebounced();
        alert(`ì—…ë¡œë“œ ì™„ë£Œ: ${list.length}ëª…`);
      } catch (err) {
        console.error(err);
        alert("ì—‘ì…€ ì½ê¸° ì‹¤íŒ¨: íŒŒì¼ í˜•ì‹/ì‹œíŠ¸ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
      } finally {
        e.target.value = "";
      }
    });

    $("btnClearPeople").addEventListener("click", () => {
      if (!isUnlocked()) return;
      state.people = [];
      state.teamA = [];
      state.teamB = [];
      state.matchesM = [];
      state.matchesF = [];
      state.matchesX = [];
      state.sit = { A: [], B: [], scoreA: "", scoreB: "" };
      $("orderWin").textContent = "â€”";
      $("orderLose").textContent = "â€”";
      renderAll();
      saveStateDebounced();
    });

    $("btnNormalize").addEventListener("click", () => {
      if (!isUnlocked()) return;
      state.people = dedupePeople(state.people);
      renderCounts();
      saveStateDebounced();
      alert("ì¤‘ë³µ ì œê±° ì™„ë£Œ");
    });

    $("btnAddManual").addEventListener("click", () => {
      if (!isUnlocked()) return;
      const { out, failed } = parseManualLines($("manualInput").value);
      state.people = dedupePeople([...state.people, ...out]);
      $("addedManual").textContent = out.length ? out.map(p => `${p.name} (${p.year}) ${p.gender}`).join("\n") : "(ì—†ìŒ)";
      $("failedManual").textContent = failed.length ? failed.join("\n") : "(ì—†ìŒ)";
      renderCounts();
      saveStateDebounced();
    });

    $("btnClearManual").addEventListener("click", () => {
      if (!isUnlocked()) return;
      $("manualInput").value = "";
      $("addedManual").textContent = "(ì—†ìŒ)";
      $("failedManual").textContent = "(ì—†ìŒ)";
    });

    $("btnRemoveByName").addEventListener("click", () => {
      if (!isUnlocked()) return;
      const names = ($("removeInput").value || "").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const { removed, notFound } = removeByNames(names);

      state.matchesM = [];
      state.matchesF = [];
      state.matchesX = [];
      state.sit = { A: [], B: [], scoreA: "", scoreB: "" };
      $("orderWin").textContent = "â€”";
      $("orderLose").textContent = "â€”";

      const msg = [
        `ì œì™¸ëœ ì¸ì›: ${removed}ëª…`,
        notFound.length ? `ëª…ë‹¨ì— ì—†ë˜ ì´ë¦„: ${notFound.join(", ")}` : ""
      ].filter(Boolean).join("\n");
      $("removeResult").textContent = msg || "(ì—†ìŒ)";

      renderCounts();
      if (state.teamA.length || state.teamB.length) {
        assignTeamsCross();
        renderTeamLists();
      }
      saveStateDebounced();
    });

    $("btnClearRemove").addEventListener("click", () => {
      if (!isUnlocked()) return;
      $("removeInput").value = "";
      $("removeResult").textContent = "(ì—†ìŒ)";
    });

    $("btnAssign").addEventListener("click", () => {
      if (!isUnlocked()) return;
      if (state.people.length < 2) { alert("ëª…ë‹¨ì„ ë¨¼ì € ë„£ì–´ì£¼ì„¸ìš”."); return; }
      assignTeamsCross();
      state.matchesM = [];
      state.matchesF = [];
      state.matchesX = [];
      renderAll();
      saveStateDebounced();
    });

    $("btnMakeMatches").addEventListener("click", () => {
      if (!isUnlocked()) return;
      if (!state.teamA.length && !state.teamB.length) assignTeamsCross();
      regenerateMatches();
    });

    $("btnSitminton").addEventListener("click", () => {
      if (!isUnlocked()) return;
      if (!state.teamA.length || !state.teamB.length) {
        alert("ë¨¼ì € íŒ€ ë°°ì •ì„ í•´ì£¼ì„¸ìš”.");
        return;
      }
      makeSitminton();
    });

    $("sitScoreA").addEventListener("input", (e) => {
      if (!isUnlocked()) return;
      state.sit.scoreA = e.target.value;
      renderSit();
      recomputeScoreboard();
      saveStateDebounced();
    });
    $("sitScoreB").addEventListener("input", (e) => {
      if (!isUnlocked()) return;
      state.sit.scoreB = e.target.value;
      renderSit();
      recomputeScoreboard();
      saveStateDebounced();
    });

    $("btnMakeOrder").addEventListener("click", () => {
      if (!isUnlocked()) return;
      makeGiftOrder();
    });

    // ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°(ê´€ë¦¬ì)
    function download(filename, text) {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
    $("btnExportJson").addEventListener("click", () => {
      if (!isUnlocked()) return;
      const payload = { version:"5.0", ...state, exportedAt:new Date().toISOString() };
      download("badmax_record.json", JSON.stringify(payload, null, 2));
    });
    $("btnImportJson").addEventListener("click", () => {
      if (!isUnlocked()) return;
      $("jsonFile").click();
    });
    $("jsonFile").addEventListener("change", (e) => {
      if (!isUnlocked()) return;
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          state.people = data.people || [];
          state.teamA = data.teamA || [];
          state.teamB = data.teamB || [];
          state.matchesM = data.matchesM || [];
          state.matchesF = data.matchesF || [];
          state.matchesX = data.matchesX || [];
          state.sit = data.sit || { A: [], B: [], scoreA:"", scoreB:"" };
          renderAll();
          saveStateDebounced();
          alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
        } catch (err) {
          console.error(err);
          alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: íŒŒì¼ í™•ì¸");
        }
      };
      reader.readAsText(file);
      e.target.value = "";
    });

    // =========================
    // ì´ˆê¸° ë¡œë“œ
    // =========================
    loadStateFromStorage();
    // ì²« ë¡œê³ ê°€ ì—†ìœ¼ë©´ ë¡œê³  ì—…ë¡œë“œ ë²„íŠ¼ ë…¸ì¶œ(í•œ ë²ˆë§Œ)
    applyLockUI();
    renderAll();
  </script>
</body>
</html>
